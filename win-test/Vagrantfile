require_relative "../lib/hosts_trigger"

Vagrant.configure("2") do |config|
  config.vm.box = "gusztavvargadr/windows-10"

  config.vm.network "public_network"
  config.vm.hostname = "win-client"

  # Windows requires WinRM for communication (Default for this box)
  config.vm.communicator = "winrm"

  config.vm.provider "hyperv" do |hv|
    hv.vmname = "win-client"
    hv.memory = 4096
    hv.maxmemory = 4096
    hv.cpus = 2
    hv.enable_virtualization_extensions = true
    # Linked clones speed up imports if supported by the box
    hv.linked_clone = true
  end

  # Read KDC IP from the parent folder
  kdc_ip = "127.0.0.1"
  if File.exist?('../.kdc_ip')
    kdc_ip = File.read('../.kdc_ip').strip
  end

  # Upload sub-scripts to C:\tmp\ on the VM
  # Vagrant's file provisioner copies files from host to guest.
  config.vm.provision "file", source: "setup-domain-join.ps1", destination: "C:\\tmp\\setup-domain-join.ps1"
  config.vm.provision "file", source: "setup-java.ps1",        destination: "C:\\tmp\\setup-java.ps1"
  config.vm.provision "file", source: "setup-rdp.ps1",         destination: "C:\\tmp\\setup-rdp.ps1"
  config.vm.provision "file", source: "setup-dashboard.ps1",   destination: "C:\\tmp\\setup-dashboard.ps1"
  config.vm.provision "file", source: "dashboard-win.ps1",     destination: "C:\\tmp\\dashboard-win.ps1"

  # Run the PowerShell orchestrator script
  config.vm.provision "shell", path: "provision.ps1", args: [kdc_ip], run: "always"

  # Update/clean Windows hosts file for name-based access from the host
  HostsTrigger.register(config, "win-client.corp.internal win-client")
end
