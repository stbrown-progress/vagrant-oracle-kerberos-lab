require_relative "../lib/hosts_trigger"

Vagrant.configure("2") do |config|
  config.vm.box = "generic/ubuntu2204"
  config.vm.network "public_network"

  config.vm.provider "hyperv" do |hv|
    hv.vmname = "test-client"
    hv.memory = 1024
    hv.maxmemory = 1024
    hv.enable_virtualization_extensions = true
  end

  # Read KDC IP
  kdc_ip = "127.0.0.1"
  if File.exist?('../.kdc_ip')
    kdc_ip = File.read('../.kdc_ip').strip
  end

  # Upload shared helpers, scripts, and dashboard files to the VM
  config.vm.provision "file", source: "../lib/fetch_with_retry.sh", destination: "/tmp/fetch_with_retry.sh", run: "always"
  config.vm.provision "file", source: "install-oracle.sh", destination: "/tmp/lib/install-oracle.sh", run: "always"
  config.vm.provision "file", source: "test_auth.sh", destination: "/tmp/lib/test_auth.sh", run: "always"
  config.vm.provision "file", source: "kinit-keytab.sh", destination: "/tmp/lib/kinit-keytab.sh", run: "always"
  config.vm.provision "file", source: "connect.isql", destination: "/tmp/lib/connect.isql", run: "always"
  config.vm.provision "file", source: "connect-kerb.isql", destination: "/tmp/lib/connect-kerb.isql", run: "always"
  config.vm.provision "file", source: "sqlnet-client.ora", destination: "/tmp/lib/sqlnet-client.ora", run: "always"
  config.vm.provision "file", source: "../lib/dashboard-common.sh", destination: "/tmp/dashboard-common.sh", run: "always"
  config.vm.provision "file", source: "dashboard-test.sh", destination: "/tmp/dashboard-vm.sh", run: "always"
  config.vm.provision "shell", path: "provision.sh", args: [kdc_ip], run: "always"

  # Update/clean Windows hosts file for name-based access from the host
  HostsTrigger.register(config, "test-client.corp.internal test-client")
end
